+++
tags  = []
title = "Qualcomm Hexagon"
date  = "2017-06-30 09:15:58"
+++
<p>TensorFlow に固定小数点演算を実装していた人による <a href="https://petewarden.com/2017/06/22/what-ive-learned-about-neural-network-quantization/">What I’ve learned about neural network quantization</a> という記事を読んでいたら、Snapdragon 向けにもそういう最適化をしたと書いてある。Snapdragon に載っている Hexagon なる DSP を使うらしい。調べるとなかなか歴史のある DSP で、TensorFlow 対応は Qualcomm が<a href="https://www.qualcomm.com/news/onq/2017/01/09/tensorflow-machine-learning-now-optimized-snapdragon-835-and-hexagon-682-dsp">今年はじめに発表をしていた</a>。速そう。</p><p>TF のコードを覗くも肝心なところは Hexagon SDK の中に隠れているらしく、つなぎのコードだけがコミットされている。そして TF 力がないのでどういうアーキテクチャなのかわからない・・・。</p><p>Hexagon 自体の概要は <a href="https://developer.qualcomm.com/qfile/27696/qualcomm-hexagon-architecture.pdf">Qualcomm のスライドがよくまとまっている</a>。省電力でアプリケーション固有命令をおおく備えた SIMD で VLIW の CPU ということらしい。と、これだけ読むと DSP ってそういうものでは・・・と思ってしまうけれど、汎用 CPU としても使えるくらいにはリッチでもある。メモリ保護とかもあって一応 <a href="https://github.com/torvalds/linux/tree/master/arch/hexagon">Linux を動かした</a>実績があるという。ということは何らかのコンパイラがあるということで、実際 <a href="https://github.com/llvm-mirror/llvm/tree/master/lib/Target/Hexagon">LLVM のターゲットがあった</a>。</p><p>VLIW ということで 4 命令までは pack して同時実行できる。SIMD として 64bit までの並列演算ができる。(8-bit 8 要素とか) そして 500MHz 動作かつ 4 thread までうごかせる。というかんじらしい。命令も fuse した命令が色々入っており、スループットは高いと主張している。<a href="https://developer.qualcomm.com/software/hexagon-dsp-sdk/tools">リファレンス</a>をダウンロードしてみると、その他に H.264 用の命令とかもあることがわかる。専用命令は <a href="https://github.com/llvm-mirror/llvm/blob/master/lib/Target/Hexagon/HexagonIntrinsics.td">Instrinsics</a> を使うとしても VLIW とかどうすればコンパイラに指示できるのだろうか・・・。（そして リンク先の instrinsics の定義では H.264 用とされる decbin 命令がコメントアウトされているが大丈夫なのだろうか・・・）</p><p><hr /></p><p>それにしても自分はすごく初歩的なことがわかってない。実際の Android デバイスの DSP ではどんな OS が動いており、どのくらいのメモリが DSP に割り当てられ（そのメモリはホスト OS と共有するのか？)、どんなタイミングでコードが DSP のメモリにロードされ、実行され、ホスト側の CPU と DSP はどうやって通信するのか？だいたい GPU みたいなもだと考えればいいのかなあ。そういえば GPU と違って ISA が公開されているのは好感が持てるね。</p><p><h3>GPGPU</h3></p><p>GPU といえば Snapdragon の GPU は GPGPU できるのだろうかとふと調べてみたら OpenCL に対応していた。実際に使っている話を聞いたことがないが。</p><p>そして Snapdragon のライバル <a href="http://www.samsung.com/semiconductor/minisite/Exynos/w/solution/mod_ap/8895/">Exynos</a> は DSP とかどうなってんのかなーと資料を探すも全然見当たらない。動画や音声のために色々 DSP は入ってるはずだが、Snapdragon と違ってサードパーティに公開はしていないのだろう。つまんね。ただし GPGPU は ARM のサイトに <a href="https://developer.arm.com/technologies/compute-library">Mali SDKs</a> というのがあって、それが使えるっぽい。めんどくさいから誰か Samsung と Qualcomm の両方に対応した Java の OpenCL ラッパー作ってくれないかなあ。そのくらい敷居が下がればやる気も起きるというものです。というか NDK に入れといて欲しい・・・</p><p><hr /></p><p><h3>追記</h3></p><p>その後もう少しだけ調べた。<a href="https://www.slideshare.net/QualcommDeveloperNetwork/21-hexagon-sdkmay919gg23">このスライド</a>が色々謎に答えてくれたのと、SDK をダウンロードしてみたりもした。自分の疑問への答えを記録しておく。まず OS は QuRT という RTOS. 公開資料は見当たらない、つまり大したものではない。SDK が提供するプログラミングスタイルは、その QuRT に ELF の SO をロードさせ、ホスト側から SO 内の関数を RPC で呼び出すというもの。Hexagon  SDK に IDL コンパイラがついてくる。RPC の実態は <a href="https://lwn.net/Articles/565469/">ION</a> と呼ばれる Android/Linux 提供の共有メモリというか DMA 機構らしい。</p><p>より重要な事実: Hexagon で実行するバイナリは OEM による署名が必要。つまりサードパーティのコードは動かせない！まじかよ！いみねーーー！そんなら GPU の方がいいわ・・・。TensorFlow が Hexagon 対応したといってもそこらへんのアプリが恩恵を受けられるわけではないのだなあ。がっかり。もちろん将来のバージョンの Android が Hexagon TensorFlow を同梱してくれればいいと言えなくもないけれど、そんなことが起こるのかわからないしどのみちバグがあっても直らない謎のバイナリに依存するのは OS の API だけでたくさん。はーがっかり。</p><p><hr /></p><p><h3>追記</h3></p><p>Android 8.1 に <a href="https://developer.android.com/ndk/guides/neuralnetworks/index.html">NN API</a> が入ったので、こいつが裏で Hexagon を使ってくれれば良いのであろう。使ってるのか知らんけど。</p>
