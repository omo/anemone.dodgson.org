+++
tags  = []
title = "Matplotlib Object Model"
date  = "2017-05-28 18:36:50"
+++
<p>Matplotlib を使ったコードを写経しようとしたが 10 行くらいで発狂しそうになる。この API, 眺めてるときからクソだと思ってたけれど自分で書くのは更に苦痛。耐えられませぬ...</p><p>しかし今回は high level な API に逃げないと決めているので、なんとかこの人たちの気持ちを理解しようと<a href="http://matplotlib.org/contents.html">公式のドキュメント</a>を読んでみる。と、一定程度理解が深まり殺意も和らいだのでみんな読むと良いよ、という話。</p><p>まず <a href="http://matplotlib.org/users/intro.html">Introduction</a> から。「表面的には Matlab インスパイヤな API だけれど中は割と object oriented だよ」という。かすかな希望を抱いて次に <a href="http://matplotlib.org/users/tutorials.html">Introductory Tutorial</a> を一通り眺める。それから <a href="http://matplotlib.org/users/artists.html">Artist Tutorial</a> を読む。</p><p>わかること:</p><p><ul>
    <li>Matplotlib の API 呼び出しは、内部の DOM みたいなのを構築したり、オブジェクトのパラメタをセットしたりするものである。そうやって作ったオブジェクトモデルを最後に show() で描画する。</li>
    <li>オブジェクトモデルの中心は <a href="http://matplotlib.org/api/artist_api.html">Artist</a> と呼ばれるオブジェクト群。Artist は DOM の Node みたいなもの。Artist の中にはコンテナの役割を果たす <a href="https://matplotlib.org/api/figure_api.html#matplotlib.figure.Figure">Figure</a> と <a href="http://matplotlib.org/api/axes_api.html#matplotlib.axes.Axes">Axes</a>, 末端のプリミティブとして Line2D やらなんやらがある。</li>
    <li>中でも主役は Axes オブジェクトで、Pyplot API call の大半はこのオブジェクトにリダイレクトされる。plot() などの API を呼ぶと、プリミティブである Line2D などが構築され、適当にプロパティをセットされ、そして Axes に追加される。Axes の API を使わず Line2D のオブジェクトを直接 instantiate することもできる（が、特に使いみちはなさげ。）Figure は Axes のコンテナ。</li>
    <li>Pyplot には "現在の Figure" や "現在の Axes" という概念があり、plt.* API の多くはショートカットとしてこの「現在のオブジェクト」たちにリダイレクトされる。</li>
</ul></p><p>あのクソのような API たちもあくまでショートカットなのですよ・・・ちゃんとオブジェクトモデルあるよ・・・といわれると多少許してあげようという気になる。特にかっこいいデザインではないし Axes のモデルなんかは不必要に複雑だと思うけれども、理不尽というほどでもない。こんなもんだよなと諦めはついた。</p><p><hr /></p><p>まえに <a href="https://www.coursera.org/specializations/jhu-data-science">Coursera のクラス</a>でさわった <a href="http://ggplot2.tidyverse.org/reference/">ggpot2</a> がかっこよすぎたせいでどうしても可視化 API への期待値があがってしまう。あそこまでかっこよくなくていいんだけど、せめでもうちょっとなんとかならなかったのか。でも Python は気の利いた API をつくるための文法が弱いよね。たとえば Ruby のようなブロック構文があったらだいぶ可愛くできるはずだけれど、Python に block はない。フル機能の lambda もない。R みたいに AST を quote/unparse することもできない。きびしい。</p><p><a href="http://plotnine.readthedocs.io/en/latest/">Plotnine</a> のように ggplot を模倣するライブラリはあるから Python の言語機能が完全に力不足というわけでもないのだけれど (すくなくとも operator overloading はある)、一方で ORM みたいに多くのプログラマがよってたかって作りなおせるほど敷居の低いジャンルでもないから、Matplotlib のような kind of good enough なものが生き残ってしまうのだろうなあ。まあ <a href="https://github.com/altair-viz/altair">Altair</a> などを片目でひやかしつつしばらくは Matplotlib 修行します。はい。</p><p><hr /></p><p><h3>追記</h3></p><p><a href="http://pbpython.com/effective-matplotlib.html">Effectively Using Matplotlib</a> という記事を見かけた。この人は常に object oriented API を使えと言っているなあ。そして Pandas の plot と Matplotlib を混ぜて使っている。自分はこの二つを混ぜられないと勝手に思い込んでいたけれど、たしかに Pandas で書きつつ Matplotlib でカスタマイズするのは良い手に思える。</p><p>&nbsp;</p>
