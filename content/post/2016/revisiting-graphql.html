+++
tags  = []
title = "Revisitng GraphQL"
date  = "2016-09-14 21:02:38"
+++
<p><a href="http://githubengineering.com/the-github-graphql-api/">GitHub が GraphQL をサポートした</a>というニュースに驚き、久しぶりに<a href="http://graphql.org/">資料</a>を眺めている。</p><p>以前みた時は、クライアント側は嬉しいけれどサーバ側を書くのが大変そうな印象だった。<a href="http://graphql.org/code/">GraphQL サーバのフレームワークたち</a>は、フレームワーク側がクエリを型単位のリクエストに分解する。フレームワークを使う側はデータを取得する "resolver" 一式を個々の型に実装する。</p><p>バックエンドが microservices や nosql になってしまっている大規模サービスなら悪くないデザインだけど、RDB から一撃で色々ひっこぬきたい人たちには嬉しくなさそうに見える。実質上 ORM の one-to-many association で lazy evaluation をするみたいになってしまい、性能上の問題もありそうだし。(なおこの問題を <a href="http://stackoverflow.com/questions/97197/what-is-the-n1-selects-issue">N+1 problem</a> と呼ぶことを今更知った。) API endpoints をトラバースする手間がクライアントサイドからフロントエンドのサーバに移るだけだと、仕組みの大袈裟さに対する有り難みが小さく感じる。GraphQL の issue にも<a href="https://github.com/graphql/graphql-js/issues/111">その申し立てがある</a>。</p><p>調べてみると, GraphQL ライブラリのいくつかは N+1 problem への処方箋を持っていた。具体的には "N 回のリクエスト" を "N 個のオブジェクトを取り出す 1 回のリクエスト" にまとめようとする。なので N+1 が 1+1 になる。1 ではないけれど N+1 よりはだいぶいい。ただネストが深くなるとどこかで N が顔を出しそうではある。</p><p>Scala の GraphQL 実装である <a href="http://sangria-graphql.org/">Sangria</a> はバッチ化したいオブジェクトを Deferred という generic type で表す。するとフレームワーク側が同じ型の deferreds をまとめ、一撃で取得するリクエストを投げ、その結果をまとめて返してくれる。<a href="http://sangria-graphql.org/learn/#deferred-values-and-resolver">らしい</a>。</p><p>Facebook が公開している <a href="https://github.com/facebook/dataloader">DataLoader</a> という JS のライブラリも似た感じ。データをすべて Promise でラップし、Promise の解決をバッチ化する。フレームワークにくっついておらずAPI が素直、<a href="https://github.com/facebook/dataloader/blob/master/src/index.js">コードも小さい</a>。これを書いた人は Promise わかってんなというかんじがして良い。README には <a href="https://github.com/graphql/graphql-js">graphql-js</a> と組み合わせてつかう例が載っている。関係ないけどその README 冒頭でちらっと書いてある background story がよい。その Ent っていうフレームワーク、むかしなんかの techtalk で聞いたよ! などと FB tech watcher としてにわかに盛り上がる。</p><p>Ruby では <a href="https://github.com/Shopify/graphql-batch">graphql-batch</a> を使うと Github のブログに書いてある。読んでないけど似たようなもんなのでしょう。Intuit も使っているというから来年の確定申告がちょっとだけ楽しみになった...とおもったら TurboTax じゃなくて <a href="http://careers.intuit.com/job-category/1/software-engineering/job/00123459/architect">QuickBook か</a>。残念...どうでもいいですが...</p><p>という具合に当初の印象に反しサーバ側もじりじり使いやすくなりつつあるかんじなのだろうか。</p><p>クライアント側。JS ならさておき Android はどうなのかなあ。<a href="https://github.com/graphql-java/graphql-java">graphql-java</a> というのをつかうっぽいけれど、データを Java のオブジェクトにマップしてくれないとつらい。Java のクラスで GraphQL の型を表現する <a href="https://github.com/graphql-java/graphql-java-annotations">graphql-java-annotations</a> なんてのがあるからあと一歩。Facebook がどうしているのか知りたい。<a href="https://facebook.github.io/react/blog/2015/05/01/graphql-introduction.html">ほんとに Android 向けで GraphQL</a> 使ってるんだろうか。まあビルドシステムとべったりくっついててオープンソースに切り離せないとかなんだろうね。</p><p>現状だとまだ React スタックな人向けのフレームワークだなという印象。React-Redux-Relay-GraphQL のなにかをつくるのは楽しそうではある。AWS Lambda の API gateway みたいなレイヤが GraphQL を解釈して背後の lambda に dispatch してくれるなどの支援がすすみ、趣味プログラマからも手が届くテクノロジになってほしいもんです。</p>
