+++
Tags = []
date = "2015-04-13"
title = "書き直しのスペクトラム"
draft = true
+++

なんとなく続き。

自分はいままで、書き直しについてことさら何か書く気が起きなかった。
どうでもいい話に思えてしまう。理由は幾つかある。

## 部分的な書き直し

一つ目は、書き直しがゼロかイチかの大きな判断ではないと気付いたからかもしれない。コードの書き換えには様々な粒度がある。一番小さいのが厳密なリファクタリング。一番大きいのがフルスクラッチの書き直し。その間には様々な大きさの書き直しがある。書き直しの粒度が連続的である以上、どちらか一端を擁護する議論は虚しい。

小さい刻みの変更を積み重ねれば危険を冒さず大きな変更ができる。それがリファクタリングのテネットだ。刻みは小さいほど安全だから、良いプログラマは大きな変更を連続した小さい変更へと噛み砕く。変更の難しさに実力が及ばないと刻みが大きくなり失敗の危険が増す。バグが増えたり納期に遅れたりする。

自分の能力を超えた変更を求められることはある。仕方なく刻みを緩める。そうはいってもフルスクラッチの書き直しをすることはない。大半は部分的な、たとえばモジュール単位の、書き直しで事足りる。Microservices にしたってモノリシックなアプリケーションの一部を別のプロセスに切り離すことから始まる。一見フルスクラッチを避けがたい場面ですら、十分な(あるいは例外的な)能力をもってすれば安全にそれをやりとげられる。Russ Cox の [異言語間 Go コンパイラ移植](https://golang.org/s/go13compiler) はその極端な例。

## 互換性を諦める

もう一つの理由は、互換性への期待が変わったことだろうか。フルスクラッチな書き直しへの批判は、書き直された新版が旧版と互換性を保つ難しさを論拠の一つにしている。一方で多くのソフトウェアは互換性を捨てながら前に進んでいる。API は deprecate される。刷新された UI からは不人気な機能が姿を消す。ウェブ標準ですら古い API のうち評判が悪かったものを取り下げている。この非互換は書き直しのバグではなく意思決定の結果だ。

互換性を損ねると決めた途端、書き直しは楽になる。決まった範囲で互換性を壊しつつ新しい方向に進めばいい。自暴自棄のフルスクラッチに走りたい衝動は遠ざかる。

Windows 10 に載る新しいウェブブラウザのレンダリングエンジン Edge は、古いエンジン Trident をフォークしたものだ。その違いは既に [WebKit と Blink より大きいという](http://www.smashingmagazine.com/2015/01/26/inside-microsofts-new-rendering-engine-project-spartan/
)。Edge は近代的なウェブでの競争力を理由に IE との互換性を捨てると決め、大きな書き直しの扉を開けた。IE の足を引っぱっていたのはひどいコードでなく互換性の鎖だった。まあコードもひどかったに違いないけれど、それだけが相手ならプログラマがなんとかできるってことだね。


## 前世紀末の呪い

書き直しの切り口はいくらでもあるし、互換性は時に捨てることもできる。フルスクラッチでの書き直しを強行する理由をもはや自分は見出せない。けれど 15 年前に Joel Spolsky が[書き直しは悪](http://www.joelonsoftware.com/articles/fog0000000069.html)と書いた時、それは人々の心に響いた。なぜか。西暦 2000 年と今は何が違うのか。

槍玉にあげられたソフトウェアの一つは、奇しくもまたウェブブラウザ。Netscape の失敗を Joel は批判した。Netscape はその後 IE に負け AOL に買収されてしまったわけだから、この書き直しを失敗とみなすのは的外れでもなかろう。今だったら「スクラッチで書き直しとかあいつら狂ってるな・・・」で終わる話。けれどたしかに 15 年前、フルスクラッチの書き直しはよくある話だった気がする。

書籍 [Refactoring](http://www.amazon.com/dp/0201485672) の出版が 1999 年。連続した安全な書き換えというアイデアは今ほど浸透していなかった。コードは少しずつ腐っていくもの。腐敗を遅らせるのがせいぜい。ソフトウェアのリリースは今よりずっと離散的で、オートアップデートの仕組みもなかった。だから仮に少しずつコードを直せても、それを撒いて試すのは難しかった。人々は健全性を取り戻す術をフルスクラッチ以外に持っていなかったのかもしれない。

一方、ソフトウェアの互換性に対する期待は今よりずっと高かった。それはたぶん Microsoft が持ち込んだゲームのルールだった。彼らは互換性のために莫大な工学資本をつぎ込んで高いバーを設けた。ウェブの時代がそれを塗り替えるまで、互換性への期待はソフトウェアの前に立ちふさがっていた。「同じものは壊れない」というユーザの期待が「まったく新しい何か」へと開発者を追い込み、結果として「すっかり壊れた何か」を生み出し破滅を招いた。

15 年前、ソフトウェア開発者は少しずつ直すことを知らず、少しだけ壊すこともできなかった。フルスクラッチの決断は板挟みの症状だった。だいぶ単純化してるけど、時代の空気はそんな風だった気がする。

それから時は流れた。もはやフルスクラッチの書き直しで自分の稼ぎ口をふいにするまともな開発者はいまい。Sacrificed Architecture も全てをゼロから書き直せとは言っていない。でも身構えてしまう。書き直しへの興味の薄れと書き直し論に対する過剰な反発。自分がこんな矛盾を抱えているのは、時代の変化を内面化できていないからかね。

たまにはフルスクラッチもいいじゃん、という話を書こうと思ってたのにまた長くなりすぎた・・・。


